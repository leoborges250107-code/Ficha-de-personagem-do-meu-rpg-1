<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Ficha de RPG com Login</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #E6E0F8; /* roxo claro */
    padding: 20px;
    color: #3C2F5E; /* roxo escuro para texto */
  }
  h1, h2 {
    text-align: center;
    color: #4B3F72;
  }
  .container {
    max-width: 800px;
    margin: auto;
    background: #F3EFFF; /* lilás bem clarinho */
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 0 12px rgba(75, 63, 114, 0.4);
  }
  label {
    font-weight: bold;
    margin-top: 10px;
    display: block;
    color: #4B3F72;
  }
  input[type="text"], input[type="password"], input[type="number"], textarea {
    padding: 6px;
    margin-top: 4px;
    width: 100%;
    box-sizing: border-box;
    font-size: 1em;
    border-radius: 5px;
    border: 1px solid #B9A9D6;
    background: #F9F6FF;
    color: #3C2F5E;
  }
  textarea {
    min-height: 80px;
    resize: vertical;
  }
  button {
    margin: 10px 0 5px 0;
    padding: 12px;
    width: 100%;
    font-size: 16px;
    border: none;
    background: #6A5ACD;
    color: white;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.3s;
  }
  button:hover {
    background: #4B3F72;
  }
  .erro {
    color: #B22222;
    font-weight: bold;
    margin-bottom: 10px;
    display: none;
  }
  .atributo {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 8px 0;
  }
  .atributo label {
    flex: 1 0 120px;
  }
  .atributo input[type=number] {
    width: 60px;
    text-align: center;
  }
  .bonus {
    width: 50px;
    font-weight: bold;
    text-align: center;
    flex: 0 0 50px;
  }
  .bonus.positivo {
    color: #6A5ACD;
  }
  .bonus.negativo {
    color: #9E7CC2;
  }
  .pontos-restantes {
    font-size: 18px;
    margin: 10px 0 6px 0;
    color: #4B3F72;
    font-weight: bold;
  }
  #erroLogin, #erroCadastro {
    margin-top: 10px;
  }
  #logoutBtn {
    background: #B22222;
  }
  #logoutBtn:hover {
    background: #7A1717;
  }
  /* Hide sections by default */
  #loginSection, #fichaSection {
    display: none;
  }
</style>
</head>
<body>

<div class="container" id="loginSection">
  <h1>Login - Ficha RPG</h1>
  <label for="loginUser">Nome de usuário:</label>
  <input type="text" id="loginUser" autocomplete="username" />
  <label for="loginPass">Senha:</label>
  <input type="password" id="loginPass" autocomplete="current-password" />
  <button id="btnLogin">Entrar</button>
  <div class="erro" id="erroLogin"></div>

  <hr style="margin:20px 0; border-color:#B9A9D6" />

  <h2>Cadastro</h2>
  <label for="cadUser">Nome de usuário:</label>
  <input type="text" id="cadUser" autocomplete="username" />
  <label for="cadPass">Senha:</label>
  <input type="password" id="cadPass" autocomplete="new-password" />
  <button id="btnCadastro">Cadastrar</button>
  <div class="erro" id="erroCadastro"></div>
</div>

<div class="container" id="fichaSection">
  <h1>Ficha de RPG Completa</h1>
  <button id="logoutBtn">Logout</button>

  <label for="nivel">Nível:</label>
  <input type="number" id="nivel" min="1" value="1" />

  <label for="nome">Nome:</label>
  <input type="text" id="nome" />

  <label for="classe">Classe:</label>
  <input type="text" id="classe" />

  <label for="raca">Raça:</label>
  <input type="text" id="raca" />

  <label for="antecedente">Antecedente:</label>
  <input type="text" id="antecedente" />

  <h3>Atributos</h3>
  <div id="atributos"></div>

  <div class="pontos-restantes">
    Pontos restantes: <span id="pontosRestantes">28</span>
  </div>
  <div class="erro" id="erroPontos">⚠ Você não possui mais pontos disponíveis!</div>

  <label for="iniciativa">Iniciativa:</label>
  <input type="text" id="iniciativa" readonly />

  <label for="lore">Lore / Características Gerais:</label>
  <textarea id="lore" placeholder="Conte a história do seu personagem..."></textarea>

  <label for="inventario">Inventário:</label>
  <textarea id="inventario" placeholder="Liste os itens do personagem, um por linha..."></textarea>

  <label for="magias">Magias:</label>
  <textarea id="magias" placeholder="Liste as magias do personagem, um por linha..."></textarea>

  <button id="btnSalvar">Salvar Ficha</button>
  <button id="btnExportar">Exportar Ficha (TXT)</button>
</div>

<script>
  // --- Login System ---
  function getUsuarios() {
    const dados = localStorage.getItem('usuariosRPG');
    return dados ? JSON.parse(dados) : {};
  }

  function setUsuarios(users) {
    localStorage.setItem('usuariosRPG', JSON.stringify(users));
  }

  function loginUsuario(user, pass) {
    const users = getUsuarios();
    return users[user] && users[user] === pass;
  }

  function cadastrarUsuario(user, pass) {
    const users = getUsuarios();
    if(users[user]) return false; // já existe
    users[user] = pass;
    setUsuarios(users);
    return true;
  }

  // --- Variables ficha ---
  const nomesAtributos = ["Força", "Destreza", "Constituição", "Inteligência", "Sabedoria", "Carisma"];
  let atributos = {};
  let usuarioLogado = null;

  function calculaBonus(valor) {
    return Math.floor((valor - 10) / 2);
  }

  function criarCamposAtributos() {
    const container = document.getElementById("atributos");
    container.innerHTML = "";
    for (let nome of nomesAtributos) {
      atributos[nome] = 8;
      let linha = document.createElement("div");
      linha.className = "atributo";
      linha.innerHTML = `
        <label for="attr_${nome}">${nome}:</label>
        <input type="number" id="attr_${nome}" value="8" min="8" max="20" />
        <span class="bonus negativo" id="bonus_${nome}">-1</span>
      `;
      container.appendChild(linha);

      document.getElementById(`attr_${nome}`).addEventListener("input", (e) => {
        let valor = parseInt(e.target.value);
        if (isNaN(valor) || valor < 8) valor = 8;
        if (valor > 20) valor = 20;

        atributos[nome] = valor;

        let bonus = calculaBonus(valor);
        let bonusSpan = document.getElementById(`bonus_${nome}`);
        bonusSpan.textContent = bonus >= 0 ? `+${bonus}` : bonus;
        bonusSpan.className = "bonus " + (bonus >= 0 ? "positivo" : "negativo");

        atualizarPontos();
        salvarFicha();
      });
    }
  }

  function pontosTotais() {
    let nivel = parseInt(document.getElementById("nivel").value);
    if (isNaN(nivel) || nivel < 1) nivel = 1;
    return 28 + (nivel - 1) * 4;
  }

  function atualizarPontos() {
    let gasto = 0;
    for (let nome of nomesAtributos) {
      gasto += (atributos[nome] - 8);
    }
    let total = pontosTotais();
    let restante = total - gasto;

    document.getElementById("pontosRestantes").innerText = restante;

    let erroMsg = document.getElementById("erroPontos");
    if (restante < 0) {
      erroMsg.style.display = "block";
    } else {
      erroMsg.style.display = "none";
    }

    atualizarIniciativa();
  }

  function atualizarIniciativa() {
    let bonusDex = calculaBonus(atributos["Destreza"]);
    document.getElementById("iniciativa").value = bonusDex >= 0 ? `+${bonusDex}` : bonusDex;
  }

  function salvarFicha() {
    if (!usuarioLogado) return;
    const dados = {
      nivel: document.getElementById("nivel").value,
      nome: document.getElementById("nome").value,
      classe: document.getElementById("classe").value,
      raca: document.getElementById("raca").value,
      antecedente: document.getElementById("antecedente").value,
      atributos,
      lore: document.getElementById("lore").value,
      inventario: document.getElementById("inventario").value,
      magias: document.getElementById("magias").value
    };
    localStorage.setItem(`fichaRPG_${usuarioLogado}`, JSON.stringify(dados));
  }

  function carregarFicha() {
    if (!usuarioLogado) return;
    const dadosStr = localStorage.getItem(`fichaRPG_${usuarioLogado}`);
    if (!dadosStr) {
      // ficha limpa
      criarCamposAtributos();
      atualizarPontos();
      return;
    }
    const dados = JSON.parse(dadosStr);

    document.getElementById("nivel").value = dados.nivel || "1";
    document.getElementById("nome").value = dados.nome || "";
    document.getElementById("classe").value = dados.classe || "";
    document.getElementById("raca").value = dados.raca || "";
    document.getElementById("antecedente").value = dados.antecedente || "";
    document.getElementById("lore").value = dados.lore || "";
    document.getElementById("inventario").value = dados.inventario || "";
    document.getElementById("magias").value = dados.magias || "";

    if (dados.atributos) {
      for (let nome of nomesAtributos) {
        let val = dados.atributos[nome];
        if (val === undefined) val = 8;
        atributos[nome] = val;
        const input = document.getElementById(`attr_${nome}`);
        if (input) input.value = val;

        let bonus = calculaBonus(val);
        const bonusSpan = document.getElementById(`bonus_${nome}`);
        if (bonusSpan) {
          bonusSpan.textContent = bonus >= 0 ? `+${bonus}` : bonus;
          bonusSpan.className = "bonus " + (bonus >= 0 ? "positivo" : "negativo");
        }
      }
    }

    atualizarPontos();
  }

  function resetarFicha() {
    if (!usuarioLogado) return;
    if (!confirm("Tem certeza que deseja resetar a ficha? Todos os dados serão apagados.")) return;
    localStorage.removeItem(`fichaRPG_${usuarioLogado}`);
    criarCamposAtributos();
    atualizarPontos();
    document.getElementById("nivel").value = 1;
    document.getElementById("nome").value = "";
    document.getElementById("classe").value = "";
    document.getElementById("raca").value = "";
    document.getElementById("antecedente").value = "";
    document.getElementById("lore").value = "";
    document.getElementById("inventario").value = "";
    document.getElementById("magias").value = "";
    salvarFicha();
  }

  function exportarTXT() {
    if (!usuarioLogado) return;
    let texto = `Nome: ${document.getElementById("nome").value}
Classe: ${document.getElementById("classe").value}
Raça: ${document.getElementById("raca").value}
Antecedente: ${document.getElementById("antecedente").value}
Nível: ${document.getElementById("nivel").value}
Iniciativa: ${document.getElementById("iniciativa").value}

Atributos:
`;
    for (let nome of nomesAtributos) {
      texto += `${nome}: ${atributos[nome]} (Bônus: ${calculaBonus(atributos[nome])})\n`;
    }
    texto += `

Lore / Características Gerais:
${document.getElementById("lore").value}

Inventário:
${document.getElementById("inventario").value}

Magias:
${document.getElementById("magias").value}
`;

    const blob = new Blob([texto], { type: "text/plain" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "ficha_rpg.txt";
    a.click();
  }

  // --- Controle telas ---
  function mostrarLogin() {
    document.getElementById("loginSection").style.display = "block";
    document.getElementById("fichaSection").style.display = "none";
  }
  function mostrarFicha() {
    document.getElementById("loginSection").style.display = "none";
    document.getElementById("fichaSection").style.display = "block";
  }

  // --- Eventos Login e Cadastro ---
  document.getElementById("btnLogin").addEventListener("click", () => {
    const user = document.getElementById("loginUser").value.trim();
    const pass = document.getElementById("loginPass").value;
    const erro = document.getElementById("erroLogin");

    if (!user || !pass) {
      erro.textContent = "Preencha usuário e senha!";
      erro.style.display = "block";
      return;
    }
    if (loginUsuario(user, pass)) {
      erro.style.display = "none";
      usuarioLogado = user;
      iniciarSessaoUsuario();
    } else {
      erro.textContent = "Usuário ou senha incorretos!";
      erro.style.display = "block";
    }
  });

  document.getElementById("btnCadastro").addEventListener("click", () => {
    const user = document.getElementById("cadUser").value.trim();
    const pass = document.getElementById("cadPass").value;
    const erro = document.getElementById("erroCadastro");

    if (!user || !pass) {
      erro.textContent = "Preencha usuário e senha para cadastro!";
      erro.style.display = "block";
      return;
    }
    if (cadastrarUsuario(user, pass)) {
      erro.style.display = "none";
      alert("Usuário cadastrado com sucesso! Agora faça login.");
      document.getElementById("cadUser").value = "";
      document.getElementById("cadPass").value = "";
    } else {
      erro.textContent = "Usuário já existe. Escolha outro nome.";
      erro.style.display = "block";
    }
  });

  // --- Sessão do usuário ---
  function iniciarSessaoUsuario() {
    mostrarFicha();
    criarCamposAtributos();
    carregarFicha();

    // Escuta alterações para salvar
    document.getElementById("nivel").addEventListener("input", () => { atualizarPontos(); salvarFicha(); });
    document.getElementById("nome").addEventListener("input", salvarFicha);
    document.getElementById("classe").addEventListener("input", salvarFicha);
    document.getElementById("raca").addEventListener("input", salvarFicha);
    document.getElementById("antecedente").addEventListener("input", salvarFicha);
    document.getElementById("lore").addEventListener("input", salvarFicha);
    document.getElementById("inventario").addEventListener("input", salvarFicha);
    document.getElementById("magias").addEventListener("input", salvarFicha);

    document.getElementById("btnSalvar").addEventListener("click", () => {
      salvarFicha();
      alert("Ficha salva com sucesso!");
    });
    document.getElementById("btnExportar").addEventListener("click", exportarTXT);
    document.getElementById("logoutBtn").addEventListener("click", logout);
  }

  function logout() {
    usuarioLogado = null;
    mostrarLogin();
  }

  // --- Inicialização ---
  mostrarLogin();
</script>

</body>
</html>
